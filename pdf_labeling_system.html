<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Etiketleme Sistemi</title>
    <!-- Yerel PDF.js kütüphanesi -->
    <script src="lib/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .main-content {
            display: flex;
            min-height: 600px;
        }
        .sidebar {
            width: 300px;
            padding: 20px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
        }
        .workspace {
            flex: 1;
            padding: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .input-group input[type="color"] {
            width: 40px;
            height: 36px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .label-list, .pdf-list {
            margin-top: 10px;
        }
        .label-item, .pdf-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .label-item.active, .pdf-item.active {
            background: #e6f0ff;
        }
        .label-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }
        #pdfDisplay {
            border: 2px dashed #ddd;
            padding: 20px;
            min-height: 400px;
            margin-top: 20px;
        }
        #pdfCanvas {
            max-width: 100%;
        }
        .text-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.2;
            z-index: 10;
        }
        .text-layer > span {
            color: transparent;
            position: absolute;
            cursor: pointer;
            border-radius: 3px;
        }
        .text-layer > span:hover {
            background: rgba(102, 126, 234, 0.3);
            opacity: 1;
        }
        .annotation-highlight {
            position: absolute;
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid;
            pointer-events: none;
            z-index: 5;
        }
        .group-badge {
            position: absolute;
            background: white;
            border: 2px solid;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 15;
            pointer-events: none;
            top: -5px;
            right: -5px;
        }
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        #statusText {
            margin-top: 10px;
            color: #333;
        }
        .context-menu {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 5px 0;
            min-width: 200px;
        }
        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: #f0f3ff;
        }
        .context-menu-divider {
            height: 1px;
            background: #ddd;
            margin: 5px 0;
        }
        .group-input-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1001;
            padding: 20px;
            min-width: 300px;
        }
        .group-input-dialog h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        .group-input-dialog input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .group-input-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="container">
    <h1>PDF Etiketleme Sistemi</h1>
    <div class="main-content">
        <div class="sidebar">
            <div>
                <h3>Proje</h3>
                <button class="btn btn-primary" id="newProjectBtn">Yeni Proje Aç</button>
                <button class="btn btn-success" id="saveProjectBtn" disabled>Projeyi Kaydet</button>
                <button class="btn btn-primary" id="loadProjectBtn">Proje Yükle</button>
                <input type="file" id="projectFileInput" accept=".json" style="display: none;">
            </div>
            <div>
                <h3>Etiketler</h3>
                <div class="input-group">
                    <input type="text" id="labelInput" placeholder="Etiket adı" disabled>
                    <input type="color" id="colorInput" value="#ff6b6b" disabled>
                    <button class="btn btn-success" id="addLabelBtn" disabled>Ekle</button>
                </div>
                <div class="label-list" id="labelList"></div>
            </div>
            <div>
                <h3>Mod</h3>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="labelModeBtn">Etiketle</button>
                    <button class="mode-btn" id="eraserModeBtn">Silgi</button>
                </div>
            </div>
            <div>
                <h3>PDF Dosyası</h3>
                <button class="btn btn-primary" id="refreshListBtn">Listeyi Yenile</button>
                <div class="pdf-list" id="pdfList"></div>
            </div>
        </div>
        <div class="workspace">
            <div>
                <h3>PDF Görüntüleme</h3>
                <div id="pdfDisplay">PDF bekleniyor...</div>
            </div>
            <div>
                <h3>Dışa Aktar</h3>
                <button class="btn btn-success" id="exportJsonBtn" disabled>JSON İndir</button>
                <button class="btn btn-success" id="exportCsvBtn" disabled>CSV İndir</button>
            </div>
        </div>
    </div>
    <div style="margin-top: 20px;">
        <h3>İlerleme</h3>
        <canvas id="progressChart" height="50"></canvas>
    </div>
    <div id="statusText">Durum: Hazır</div>
</div>

    <script>
        // PDF.js yüklenmesini kontrol et
        if (typeof pdfjsLib === 'undefined') {
            console.error('PDF.js kütüphanesi yüklenemedi. lib/pdf.min.js dosyasını kontrol edin.');
            document.getElementById('statusText').textContent = 'Hata: PDF.js kütüphanesi yüklenemedi';
            alert('PDF.js kütüphanesi yüklenemedi. lib/pdf.min.js dosyasını kontrol edin.');
        } else {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdf.worker.min.js';
        }

        let projectData = {
            name: '',
            date: '',
            classes: {},
            files: {},
            activeLabel: null,
            isEraser: false
        };
        let currentPdfFile = null;
        let currentPdfDoc = null;
        let currentPage = 1;
        let textSpanMap = new Map();

        // DOM Elements
        const elements = {
            newProjectBtn: document.getElementById('newProjectBtn'),
            saveProjectBtn: document.getElementById('saveProjectBtn'),
            loadProjectBtn: document.getElementById('loadProjectBtn'),
            projectFileInput: document.getElementById('projectFileInput'),
            labelInput: document.getElementById('labelInput'),
            colorInput: document.getElementById('colorInput'),
            addLabelBtn: document.getElementById('addLabelBtn'),
            labelList: document.getElementById('labelList'),
            uploadPdfBtn: document.getElementById('uploadPdfBtn'),
            pdfFileInput: document.getElementById('pdfFileInput'),
            pdfList: document.getElementById('pdfList'),
            pdfDisplay: document.getElementById('pdfDisplay'),
            labelModeBtn: document.getElementById('labelModeBtn'),
            eraserModeBtn: document.getElementById('eraserModeBtn'),
            exportJsonBtn: document.getElementById('exportJsonBtn'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            statusText: document.getElementById('statusText'),
        };

        // Event Listeners
        elements.newProjectBtn.addEventListener('click', () => {
            console.log('Yeni Proje Aç tıklandı');
            createNewProject();
        });
        elements.saveProjectBtn.addEventListener('click', () => {
            console.log('Projeyi Kaydet tıklandı');
            saveProject();
        });
        elements.loadProjectBtn.addEventListener('click', () => {
            console.log('Proje Yükle butonuna tıklandı');
            elements.projectFileInput.click();
        });
        elements.addLabelBtn.addEventListener('click', () => {
            console.log('Etiket Ekle tıklandı');
            addLabel();
        });
        elements.uploadPdfBtn.addEventListener('click', () => {
            console.log('PDF Yükle butonuna tıklandı');
            elements.pdfFileInput.click();
        });
        elements.labelModeBtn.addEventListener('click', () => {
            console.log('Etiketle modu seçildi');
            projectData.isEraser = false;
            elements.labelModeBtn.classList.add('active');
            elements.eraserModeBtn.classList.remove('active');
            updateStatus(`Aktif mod: Etiketleme (${projectData.activeLabel || 'Seçilmedi'})`);
        });
        elements.eraserModeBtn.addEventListener('click', () => {
            console.log('Silgi modu seçildi');
            projectData.isEraser = true;
            projectData.activeLabel = null;
            elements.eraserModeBtn.classList.add('active');
            elements.labelModeBtn.classList.remove('active');
            updateStatus('Aktif mod: Silgi');
        });
        elements.exportJsonBtn.addEventListener('click', () => {
            console.log('JSON İndir tıklandı');
            exportJson();
        });
        elements.exportCsvBtn.addEventListener('click', () => {
            console.log('CSV İndir tıklandı');
            exportCsv();
        });
        elements.projectFileInput.addEventListener('change', loadProject);
        elements.pdfFileInput.addEventListener('change', uploadPdf);

        // Close context menu on click
        document.addEventListener('click', () => {
            const menus = document.querySelectorAll('.context-menu');
            menus.forEach(m => m.remove());
        });

        function createNewProject() {
            try {
                const projectName = prompt('Proje adını girin:');
                if (projectName) {
                    projectData = {
                        name: projectName,
                        date: new Date().toLocaleDateString('tr-TR'),
                        classes: {},
                        files: {},
                        activeLabel: null,
                        isEraser: false
                    };
                    currentPdfFile = null;
                    currentPdfDoc = null;
                    elements.saveProjectBtn.disabled = false;
                    elements.labelInput.disabled = false;
                    elements.colorInput.disabled = false;
                    elements.addLabelBtn.disabled = false;
                    elements.uploadPdfBtn.disabled = true;
                    elements.pdfFileInput.disabled = true;
                    elements.exportJsonBtn.disabled = true;
                    elements.exportCsvBtn.disabled = true;
                    elements.pdfDisplay.innerHTML = 'PDF bekleniyor...';
                    elements.pdfList.innerHTML = '';
                    elements.labelList.innerHTML = '';
                    updateStatus(`Yeni proje "${projectName}" oluşturuldu`);
                }
            } catch (err) {
                console.error('Yeni proje oluşturma hatası:', err);
                updateStatus('Hata: Yeni proje oluşturulamadı');
            }
        }

        function saveProject() {
            try {
                const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${projectData.name || 'project'}_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                updateStatus('Proje kaydedildi');
            } catch (err) {
                console.error('Proje kaydetme hatası:', err);
                updateStatus('Hata: Proje kaydedilemedi');
            }
        }

        function loadProject(e) {
            try {
                const file = e.target.files[0];
                if (!file) {
                    updateStatus('Hata: Dosya seçilmedi');
                    return;
                }
                console.log('Proje dosyası seçildi:', file.name);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (!loadedData.name || !loadedData.date || !loadedData.files || !loadedData.classes) {
                            throw new Error('Geçersiz proje dosyası formatı');
                        }
                        projectData = {
                            name: loadedData.name,
                            date: loadedData.date,
                            classes: loadedData.classes || {},
                            files: loadedData.files || {},
                            activeLabel: null,
                            isEraser: false
                        };
                        currentPdfFile = null;
                        currentPdfDoc = null;
                        elements.saveProjectBtn.disabled = false;
                        elements.labelInput.disabled = false;
                        elements.colorInput.disabled = false;
                        elements.addLabelBtn.disabled = false;
                        elements.uploadPdfBtn.disabled = false;
                        elements.pdfFileInput.disabled = false;
                        elements.exportJsonBtn.disabled = false;
                        elements.exportCsvBtn.disabled = false;
                        elements.pdfDisplay.innerHTML = 'PDF bekleniyor...';
                        renderLabels();
                        renderPdfList();
                        updateStatus(`Proje "${projectData.name}" yüklendi`);
                    } catch (err) {
                        console.error('Proje dosyası işleme hatası:', err);
                        updateStatus('Hata: Proje dosyası yüklenemedi');
                        alert('Proje dosyası yüklenemedi: ' + err.message);
                    }
                };
                reader.onerror = (err) => {
                    console.error('Proje dosyası okuma hatası:', err);
                    updateStatus('Hata: Proje dosyası okunamadı');
                };
                reader.readAsText(file);
                e.target.value = '';
            } catch (err) {
                console.error('Proje yükleme hatası:', err);
                updateStatus('Hata: Proje yüklenemedi');
            }
        }

        function addLabel() {
            try {
                const labelName = elements.labelInput.value.trim();
                const labelColor = elements.colorInput.value;
                if (labelName && !projectData.classes[labelName]) {
                    projectData.classes[labelName] = labelColor;
                    renderLabels();
                    elements.labelInput.value = '';
                    elements.uploadPdfBtn.disabled = false;
                    elements.pdfFileInput.disabled = false;
                    elements.exportJsonBtn.disabled = false;
                    elements.exportCsvBtn.disabled = false;
                    updateStatus(`Etiket "${labelName}" eklendi`);
                } else {
                    updateStatus('Hata: Etiket adı boş veya zaten mevcut');
                }
            } catch (err) {
                console.error('Etiket ekleme hatası:', err);
                updateStatus('Hata: Etiket eklenemedi');
            }
        }

        function renderLabels() {
            elements.labelList.innerHTML = '';
            Object.entries(projectData.classes).forEach(([name, color]) => {
                const item = document.createElement('div');
                item.className = `label-item ${projectData.activeLabel === name ? 'active' : ''}`;
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="label-color" style="background: ${color};"></div>
                        <span>${name}</span>
                    </div>
                    <button class="btn btn-danger" onclick="deleteLabel('${name}')">Sil</button>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('btn')) {
                        projectData.activeLabel = name;
                        projectData.isEraser = false;
                        elements.labelModeBtn.classList.add('active');
                        elements.eraserModeBtn.classList.remove('active');
                        renderLabels();
                        updateStatus(`Aktif etiket: ${name}`);
                    }
                });
                elements.labelList.appendChild(item);
            });
        }

        window.deleteLabel = function(name) {
            try {
                if (confirm(`"${name}" etiketini silmek istediğinizden emin misiniz?`)) {
                    delete projectData.classes[name];
                    if (projectData.activeLabel === name) {
                        projectData.activeLabel = null;
                    }
                    renderLabels();
                    updateStatus(`Etiket "${name}" silindi`);
                }
            } catch (err) {
                console.error('Etiket silme hatası:', err);
                updateStatus('Hata: Etiket silinemedi');
            }
        };

        async function fetchPdfList() {
    try {
        const response = await fetch('/.netlify/functions/list-pdfs');
        if (!response.ok) throw new Error('PDF listesi alınamadı');
        const files = await response.json();
        return files;
    } catch (err) {
        console.error('PDF listesi alınamadı:', err);
        updateStatus('Hata: PDF listesi yüklenemedi');
        return [];
    }
}

async function checkJsonExists(pdfName) {
    try {
        const jsonName = pdfName.replace('.pdf', '.json');
        const response = await fetch(`/.netlify/functions/check-json?file=${jsonName}`);
        return response.ok;
    } catch (err) {
        return false;
    }
}

async function renderPdfList() {
    elements.pdfList.innerHTML = '';
    const pdfFiles = await fetchPdfList();
    for (const fileName of pdfFiles) {
        const hasJson = await checkJsonExists(fileName);
        const item = document.createElement('div');
        item.className = `pdf-item ${currentPdfFile === fileName ? 'active' : ''}`;
        item.innerHTML = `
            <span style="flex: 1;">${fileName} ${hasJson ? '✔' : ''}</span>
            <button class="btn btn-danger" onclick="deletePdf('${fileName}')">Sil</button>
        `;
        item.querySelector('span').addEventListener('click', async () => {
            console.log('PDF seçildi:', fileName);
            await loadPdf(fileName);
        });
        elements.pdfList.appendChild(item);
    }
    await renderProgressBar();
}

async function loadPdf(fileName) {
    if (!projectData.files[fileName]) {
        try {
            const response = await fetch(`/pdfs/${fileName}`);
            if (!response.ok) throw new Error('PDF indirilemedi');
            const arrayBuffer = await response.arrayBuffer();
            projectData.files[fileName] = {
                annotations: {},
                pdfData: arrayBuffer,
                numPages: 0
            };
            Object.keys(projectData.classes).forEach(label => {
                projectData.files[fileName].annotations[label] = [];
            });
            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer, disableCache: true });
            const pdf = await loadingTask.promise;
            projectData.files[fileName].numPages = pdf.numPages;
            currentPdfFile = fileName;
            currentPage = 1;
            renderPdfList();
            updateStatus(`PDF "${fileName}" yükleniyor...`);
            await renderPage(1);
            await loadAnnotations(fileName);
            updateStatus(`PDF "${fileName}" yüklendi`);
        } catch (err) {
            console.error(`PDF yükleme hatası (${fileName}):`, err);
            updateStatus(`Hata: "${fileName}" yüklenemedi`);
        }
    } else {
        currentPdfFile = fileName;
        currentPage = 1;
        renderPdfList();
        await renderPage(1);
        await loadAnnotations(fileName);
        updateStatus(`PDF "${fileName}" yüklendi`);
    }
}

async function loadAnnotations(fileName) {
    try {
        const jsonName = fileName.replace('.pdf', '.json');
        const response = await fetch(`/.netlify/functions/check-json?file=${jsonName}`);
        if (response.ok) {
            const data = await response.json();
            projectData.files[fileName].annotations = data.files[fileName] || {};
            restoreAnnotations(document.querySelector('#pdfDisplay > div'), currentPage);
            updateStatus(`"${fileName}" için etiketler yüklendi`);
        } else {
            Object.keys(projectData.classes).forEach(label => {
                if (!projectData.files[fileName].annotations[label]) {
                    projectData.files[fileName].annotations[label] = [];
                }
            });
        }
    } catch (err) {
        console.error('Etiket yükleme hatası:', err);
        updateStatus('Hata: Etiketler yüklenemedi');
    }
}

async function exportJson() {
    try {
        const exportData = {
            project_name: projectData.name,
            date: projectData.date,
            classes: projectData.classes,
            files: { [currentPdfFile]: projectData.files[currentPdfFile].annotations }
        };
        const pdfName = currentPdfFile.replace('.pdf', '');
        const jsonName = `${pdfName}.json`;
        const response = await fetch('/.netlify/functions/save-json', {
            method: 'POST',
            body: JSON.stringify({ fileName: jsonName, data: exportData })
        });
        if (response.ok) {
            updateStatus('JSON kaydedildi');
            renderPdfList();
        } else {
            throw new Error('JSON kaydetme hatası');
        }
    } catch (err) {
        console.error('JSON dışa aktarma hatası:', err);
        updateStatus('Hata: JSON kaydedilemedi');
    }
}

async function renderProgressBar() {
    const pdfFiles = await fetchPdfList();
    let completedCount = 0;
    for (const fileName of pdfFiles) {
        if (await checkJsonExists(fileName)) {
            completedCount++;
        }
    }
    const totalCount = pdfFiles.length;
    const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['İlerleme'],
            datasets: [{
                label: 'Tamamlanan PDF\'ler',
                data: [percentage],
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Tamamlanma Yüzdesi (%)'
                    }
                },
                y: {
                    display: false
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.raw.toFixed(2)}% (${completedCount}/${totalCount} PDF)`;
                        }
                    }
                }
            }
        }
    });
}

document.getElementById('refreshListBtn').addEventListener('click', () => {
    renderPdfList();
    updateStatus('PDF listesi yenilendi');
});

// Otomatik yenileme (isteğe bağlı)
setInterval(() => {
    renderPdfList();
}, 30000);

        function renderPdfList() {
            elements.pdfList.innerHTML = '';
            Object.keys(projectData.files).forEach(fileName => {
                const item = document.createElement('div');
                item.className = `pdf-item ${currentPdfFile === fileName ? 'active' : ''}`;
                item.innerHTML = `
                    <span style="flex: 1;">${fileName}</span>
                    <button class="btn btn-danger" onclick="deletePdf('${fileName}')">Sil</button>
                `;
                item.querySelector('span').addEventListener('click', async () => {
                    console.log('PDF seçildi:', fileName);
                    await loadPdf(fileName);
                });
                elements.pdfList.appendChild(item);
            });
        }

        window.deletePdf = function(fileName) {
            try {
                if (confirm(`"${fileName}" dosyasını silmek istediğinizden emin misiniz?`)) {
                    delete projectData.files[fileName];
                    if (currentPdfFile === fileName) {
                        currentPdfFile = null;
                        currentPdfDoc = null;
                        elements.pdfDisplay.innerHTML = 'PDF bekleniyor...';
                    }
                    renderPdfList();
                    updateStatus('PDF silindi');
                }
            } catch (err) {
                console.error('PDF silme hatası:', err);
                updateStatus('Hata: PDF silinemedi');
            }
        };

        async function loadPdf(fileName) {
            if (typeof pdfjsLib === 'undefined') {
                updateStatus('Hata: PDF.js kütüphanesi yüklü değil');
                return;
            }
            if (!projectData.files[fileName] || !projectData.files[fileName].pdfData) {
                updateStatus(`Hata: "${fileName}" dosyası bulunamadı`);
                return;
            }
            try {
                if (currentPdfDoc) {
                    await currentPdfDoc.destroy();
                    currentPdfDoc = null;
                }
                currentPdfFile = fileName;
                currentPage = 1;
                renderPdfList();
                updateStatus(`PDF "${fileName}" yükleniyor...`);
                await renderPage(1);
                updateStatus(`PDF "${fileName}" yüklendi`);
            } catch (err) {
                console.error(`PDF yükleme hatası (${fileName}):`, err);
                updateStatus(`Hata: "${fileName}" yüklenemedi`);
            }
        }

        async function renderPage(pageNum) {
            if (!currentPdfFile) {
                updateStatus('Hata: Hiçbir PDF seçili değil');
                return;
            }
            try {
                if (!currentPdfDoc) {
                    const loadingTask = pdfjsLib.getDocument({ data: projectData.files[currentPdfFile].pdfData, disableCache: true });
                    currentPdfDoc = await loadingTask.promise;
                }
                
                currentPage = pageNum;
                const page = await currentPdfDoc.getPage(pageNum);
                const scale = 1.5;
                const viewport = page.getViewport({ scale });

                elements.pdfDisplay.innerHTML = '';
                
                // Sayfa kontrolleri ekle
                const controls = document.createElement('div');
                controls.style.cssText = 'display: flex; gap: 10px; margin-bottom: 15px; align-items: center; justify-content: center;';
                controls.innerHTML = `
                    <button class="btn btn-primary" id="prevPageBtn" ${pageNum <= 1 ? 'disabled' : ''}>◀ Önceki</button>
                    <span style="font-weight: bold; min-width: 120px; text-align: center;">Sayfa ${pageNum} / ${currentPdfDoc.numPages}</span>
                    <button class="btn btn-primary" id="nextPageBtn" ${pageNum >= currentPdfDoc.numPages ? 'disabled' : ''}>Sonraki ▶</button>
                `;
                elements.pdfDisplay.appendChild(controls);
                
                const container = document.createElement('div');
                container.style.position = 'relative';
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport }).promise;
                container.appendChild(canvas);

                const textLayer = document.createElement('div');
                textLayer.className = 'text-layer';
                textLayer.style.width = viewport.width + 'px';
                textLayer.style.height = viewport.height + 'px';
                container.appendChild(textLayer);
                elements.pdfDisplay.appendChild(container);

                const textContent = await page.getTextContent();
                pdfjsLib.renderTextLayer({
                    textContent,
                    container: textLayer,
                    viewport,
                    textDivs: []
                }).promise.then(() => {
                    setupTextInteractivity(textLayer, pageNum);
                    restoreAnnotations(container, pageNum);
                }).catch(err => {
                    console.error('Metin katmanı yükleme hatası:', err);
                    updateStatus('Uyarı: PDF metin içermiyor');
                });
                
                // Sayfa değiştirme butonları
                document.getElementById('prevPageBtn').addEventListener('click', () => {
                    if (currentPage > 1) {
                        renderPage(currentPage - 1);
                    }
                });
                
                document.getElementById('nextPageBtn').addEventListener('click', () => {
                    if (currentPage < currentPdfDoc.numPages) {
                        renderPage(currentPage + 1);
                    }
                });
                
                updateStatus(`Sayfa ${pageNum}/${currentPdfDoc.numPages} görüntüleniyor`);
            } catch (err) {
                console.error('Sayfa görüntüleme hatası:', err);
                updateStatus('Hata: PDF sayfası görüntülenemedi');
            }
        }

        function setupTextInteractivity(textLayer, pageNum) {
            const spans = textLayer.querySelectorAll('span');
            spans.forEach((span, index) => {
                const text = span.textContent.trim();
                if (!text) return;
                const spanId = `span_${pageNum}_${index}`;
                span.dataset.id = spanId;
                textSpanMap.set(spanId, { text, page: pageNum });

                // Sol tıklama
                span.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (projectData.isEraser) {
                        removeAnnotationById(spanId, pageNum);
                    } else if (projectData.activeLabel) {
                        addAnnotationById(spanId, pageNum, 1);
                    } else {
                        updateStatus('Hata: Etiket seçilmedi');
                    }
                    restoreAnnotations(textLayer.parentElement, pageNum);
                });

                // Sağ tıklama - grup menüsü
                span.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const annotation = findAnnotationBySpanId(spanId);
                    if (annotation) {
                        showContextMenu(e.clientX, e.clientY, spanId, pageNum, annotation);
                    }
                });

                span.addEventListener('mouseenter', () => {
                    if (!projectData.isEraser && projectData.activeLabel) {
                        span.style.background = projectData.classes[projectData.activeLabel] + '40';
                    }
                });
                span.addEventListener('mouseleave', () => {
                    span.style.background = '';
                });
            });
        }

        function addAnnotationById(spanId, pageNum, group) {
            try {
                // Önce tüm etiketlerden bu span'ı kaldır
                Object.keys(projectData.classes).forEach(label => {
                    const annotations = projectData.files[currentPdfFile].annotations[label] || [];
                    projectData.files[currentPdfFile].annotations[label] = annotations.filter(
                        ann => ann.spanId !== spanId
                    );
                });
                
                // Yeni etikete ekle
                if (!projectData.files[currentPdfFile].annotations[projectData.activeLabel]) {
                    projectData.files[currentPdfFile].annotations[projectData.activeLabel] = [];
                }
                projectData.files[currentPdfFile].annotations[projectData.activeLabel].push({
                    spanId: spanId,
                    page: pageNum,
                    group: group || 1
                });
            } catch (err) {
                console.error('Etiketleme hatası:', err);
                updateStatus('Hata: Etiket eklenemedi');
            }
        }

        function removeAnnotationById(spanId, pageNum) {
            try {
                Object.keys(projectData.classes).forEach(label => {
                    const annotations = projectData.files[currentPdfFile].annotations[label] || [];
                    projectData.files[currentPdfFile].annotations[label] = annotations.filter(
                        ann => ann.spanId !== spanId
                    );
                });
            } catch (err) {
                console.error('Etiket silme hatası:', err);
                updateStatus('Hata: Etiket silinemedi');
            }
        }

        function findAnnotationBySpanId(spanId) {
            for (const [label, annotations] of Object.entries(projectData.files[currentPdfFile].annotations)) {
                const found = annotations.find(ann => ann.spanId === spanId);
                if (found) return { ...found, label };
            }
            return null;
        }

        function showContextMenu(x, y, spanId, pageNum, annotation) {
            // Eski menüyü kaldır
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) existingMenu.remove();

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.innerHTML = `
                <div class="context-menu-item" data-action="change-group">
                    Grup Değiştir (Şu an: ${annotation.group || 1})
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" data-action="remove">
                    Etiketi Kaldır
                </div>
            `;

            menu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (action === 'change-group') {
                    showGroupDialog(spanId, pageNum, annotation);
                } else if (action === 'remove') {
                    removeAnnotationById(spanId, pageNum);
                    restoreAnnotations(document.querySelector('#pdfDisplay > div'), pageNum);
                }
                menu.remove();
            });

            document.body.appendChild(menu);
        }

        function showGroupDialog(spanId, pageNum, annotation) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'group-input-dialog';
            dialog.innerHTML = `
                <h3>Grup Numarası Ata</h3>
                <input type="number" id="groupInput" min="1" value="${annotation.group || 1}" placeholder="Grup numarası (1, 2, 3...)">
                <div class="group-input-dialog-buttons">
                    <button class="btn btn-primary" id="groupOkBtn">Tamam</button>
                    <button class="btn btn-danger" id="groupCancelBtn">İptal</button>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(dialog);

            const input = document.getElementById('groupInput');
            input.focus();
            input.select();

            document.getElementById('groupOkBtn').addEventListener('click', () => {
                const groupNum = parseInt(input.value) || 1;
                changeAnnotationGroup(spanId, pageNum, annotation.label, groupNum);
                overlay.remove();
                dialog.remove();
                restoreAnnotations(document.querySelector('#pdfDisplay > div'), pageNum);
            });

            document.getElementById('groupCancelBtn').addEventListener('click', () => {
                overlay.remove();
                dialog.remove();
            });

            overlay.addEventListener('click', () => {
                overlay.remove();
                dialog.remove();
            });
        }

        function changeAnnotationGroup(spanId, pageNum, label, newGroup) {
            try {
                const annotations = projectData.files[currentPdfFile].annotations[label];
                const ann = annotations.find(a => a.spanId === spanId);
                if (ann) {
                    ann.group = newGroup;
                    updateStatus(`Grup ${newGroup} olarak değiştirildi`);
                }
            } catch (err) {
                console.error('Grup değiştirme hatası:', err);
                updateStatus('Hata: Grup değiştirilemedi');
            }
        }

        function restoreAnnotations(container, pageNum) {
            // Eski highlight'ları ve badge'leri temizle
            const existingHighlights = container.querySelectorAll('.annotation-highlight');
            const existingBadges = container.querySelectorAll('.group-badge');
            existingHighlights.forEach(h => h.remove());
            existingBadges.forEach(b => b.remove());

            Object.entries(projectData.classes).forEach(([label, color]) => {
                const annotations = projectData.files[currentPdfFile]?.annotations[label] || [];
                annotations.forEach(ann => {
                    if (ann.page === pageNum) {
                        const textLayer = container.querySelector('.text-layer');
                        const span = textLayer.querySelector(`[data-id="${ann.spanId}"]`);
                        if (!span) return;

                        const spanRect = span.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();

                        const highlight = document.createElement('div');
                        highlight.className = 'annotation-highlight';
                        highlight.style.backgroundColor = color;
                        highlight.style.opacity = '0.3';
                        highlight.style.left = `${spanRect.left - containerRect.left}px`;
                        highlight.style.top = `${spanRect.top - containerRect.top}px`;
                        highlight.style.width = `${spanRect.width}px`;
                        highlight.style.height = `${spanRect.height}px`;
                        highlight.style.borderColor = color;
                        container.appendChild(highlight);

                        // Grup badge ekle (grup 2 ve üzeri için)
                        if (ann.group && ann.group > 1) {
                            const badge = document.createElement('div');
                            badge.className = 'group-badge';
                            badge.textContent = ann.group;
                            badge.style.borderColor = color;
                            badge.style.color = color;
                            badge.style.left = `${spanRect.right - containerRect.left - 10}px`;
                            badge.style.top = `${spanRect.top - containerRect.top - 5}px`;
                            container.appendChild(badge);
                        }
                    }
                });
            });
        }

        function exportJson() {
            try {
                const exportData = {
                    project_name: projectData.name,
                    date: projectData.date,
                    classes: projectData.classes,
                    files: {}
                };
                
                Object.entries(projectData.files).forEach(([fileName, data]) => {
                    exportData.files[fileName] = {};
                    Object.entries(projectData.classes).forEach(([label]) => {
                        const annotations = data.annotations[label] || [];
                        
                        // Gruplara ayır
                        const groups = {};
                        annotations.forEach(ann => {
                            const groupNum = ann.group || 1;
                            if (!groups[groupNum]) {
                                groups[groupNum] = [];
                            }
                            const spanInfo = textSpanMap.get(ann.spanId);
                            if (spanInfo) {
                                groups[groupNum].push(spanInfo.text);
                            }
                        });
                        
                        // Her grubu ayrı anahtar olarak ekle
                        Object.entries(groups).forEach(([groupNum, texts]) => {
                            const key = groupNum > 1 ? `${label}_Grup${groupNum}` : label;
                            exportData.files[fileName][key] = texts;
                        });
                    });
                });
                
                // PDF adını al (uzantısız)
                const pdfName = currentPdfFile ? currentPdfFile.replace('.pdf', '') : projectData.name || 'export';
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${pdfName}.json`;
                a.click();
                URL.revokeObjectURL(url);
                updateStatus('JSON olarak dışa aktarıldı');
            } catch (err) {
                console.error('JSON dışa aktarma hatası:', err);
                updateStatus('Hata: JSON dışa aktarılamadı');
            }
        }

        function exportCsv() {
            try {
                let csv = 'PDF Dosyası,Etiket,Değer\n';
                
                Object.entries(projectData.files).forEach(([fileName, data]) => {
                    Object.entries(projectData.classes).forEach(([label]) => {
                        const annotations = data.annotations[label] || [];
                        
                        // Gruplara ayır
                        const groups = {};
                        annotations.forEach(ann => {
                            const groupNum = ann.group || 1;
                            if (!groups[groupNum]) {
                                groups[groupNum] = [];
                            }
                            const spanInfo = textSpanMap.get(ann.spanId);
                            if (spanInfo) {
                                groups[groupNum].push(spanInfo.text);
                            }
                        });
                        
                        // Her grubu ayrı satır olarak ekle
                        Object.entries(groups).forEach(([groupNum, texts]) => {
                            const key = groupNum > 1 ? `${label}_Grup${groupNum}` : label;
                            const value = texts.join(' ');
                            csv += `"${fileName}","${key}","${value}"\n`;
                        });
                    });
                });
                
                // PDF adını al (uzantısız)
                const pdfName = currentPdfFile ? currentPdfFile.replace('.pdf', '') : projectData.name || 'export';
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${pdfName}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                updateStatus('CSV olarak dışa aktarıldı');
            } catch (err) {
                console.error('CSV dışa aktarma hatası:', err);
                updateStatus('Hata: CSV dışa aktarılamadı');
            }
        }

        function updateStatus(message) {
            elements.statusText.textContent = `Durum: ${message}`;
        }
    </script>
</body>
</html>
